var LenaJS={getImage:function(img){var c=document.createElement("canvas");c.width=img.width,c.height=img.height;var ctx=c.getContext("2d");return ctx.drawImage(img,0,0),ctx.getImageData(0,0,img.width,img.height)},printCanvas:function(selector,idata){selector.width=idata.width,selector.height=idata.height,selector.getContext("2d").putImageData(idata,0,0)},filterImage:function(selector,filter,image){var args=[this.getImage(image)];return this.printCanvas(selector,filter.apply(null,args))},redrawCanvas:function(selector,filter){var ctx=selector.getContext("2d");return ctx=[ctx.getImageData(0,0,selector.width,selector.height)],this.printCanvas(selector,filter.apply(null,ctx))},convolution:function(pixels,weights){for(var side=Math.round(Math.sqrt(weights.length)),halfSide=Math.floor(side/2),src=pixels.data,canvasWidth=pixels.width,canvasHeight=pixels.height,outputData=document.createElement("canvas").getContext("2d").createImageData(canvasWidth,canvasHeight),y=0;y<canvasHeight;y++)for(var x=0;x<canvasWidth;x++){for(var dstOff=4*(y*canvasWidth+x),sumReds=0,sumGreens=0,sumBlues=0,kernelY=0;kernelY<side;kernelY++)for(var kernelX=0;kernelX<side;kernelX++){var currentKernelY=y+kernelY-halfSide,currentKernelX=x+kernelX-halfSide;if(currentKernelY>=0&&currentKernelY<canvasHeight&&currentKernelX>=0&&currentKernelX<canvasWidth){var offset=4*(currentKernelY*canvasWidth+currentKernelX),weight=weights[kernelY*side+kernelX];sumReds+=src[offset]*weight,sumGreens+=src[offset+1]*weight,sumBlues+=src[offset+2]*weight}}outputData.data[dstOff]=sumReds,outputData.data[dstOff+1]=sumGreens,outputData.data[dstOff+2]=sumBlues,outputData.data[dstOff+3]=255}return outputData},gradient:function(deltaX,deltaY){for(var srcX=deltaX.data,canvasWidth=deltaX.width,canvasHeight=deltaX.height,srcY=deltaY.data,outputData=document.createElement("canvas").getContext("2d").createImageData(canvasWidth,canvasHeight),outputDataDir=new Array(srcX.length).fill(0),y=0;y<canvasHeight;y++)for(var x=0;x<canvasWidth;x++){var dstOff=4*(y*canvasWidth+x);outputData.data[dstOff]=Math.sqrt(Math.pow(srcX[dstOff],2)+Math.pow(srcY[dstOff],2)),outputData.data[dstOff+1]=Math.sqrt(Math.pow(srcX[dstOff+1],2)+Math.pow(srcY[dstOff+1],2)),outputData.data[dstOff+2]=Math.sqrt(Math.pow(srcX[dstOff+2],2)+Math.pow(srcY[dstOff+2],2)),outputData.data[dstOff+3]=255,outputDataDir[dstOff]=Math.atan2(srcY[dstOff],srcX[dstOff]),outputDataDir[dstOff+1]=Math.atan2(srcY[dstOff+1],srcX[dstOff+1]),outputDataDir[dstOff+2]=Math.atan2(srcY[dstOff+2],srcX[dstOff+2]),outputDataDir[dstOff+3]=255}return{magnitude:outputData,direction:outputDataDir}},histogram:function(image){"use strict";for(var pixels=this.getImage(image),zeroedArray=new Array(257).join("0").split(""),histogram={r:zeroedArray.map(Number),g:zeroedArray.map(Number),b:zeroedArray.map(Number)},i=0;i<pixels.data.length;i+=4)histogram.r[pixels.data[i]]++,histogram.g[pixels.data[i+1]]++,histogram.b[pixels.data[i+2]]++;return histogram},nonMaximumSuppression:function(pixels,direction){for(var side=Math.round(Math.sqrt(25)),halfSide=Math.floor(side/2),src=pixels.data,canvasWidth=pixels.width,canvasHeight=pixels.height,outputData=document.createElement("canvas").getContext("2d").createImageData(canvasWidth,canvasHeight),y=0;y<canvasHeight;y++)for(var x=0;x<canvasWidth;x++){for(var dstOff=4*(y*canvasWidth+x),maxReds=src[dstOff],maxGreens=src[dstOff+1],maxBlues=src[dstOff+2],kernelY=0;kernelY<side;kernelY++)for(var kernelX=0;kernelX<side;kernelX++){var currentKernelY=y+kernelY-halfSide,currentKernelX=x+kernelX-halfSide;if(currentKernelY>=0&&currentKernelY<canvasHeight&&currentKernelX>=0&&currentKernelX<canvasWidth){var offset=4*(currentKernelY*canvasWidth+currentKernelX),currentKernelAngle=Math.atan2(currentKernelY-y,currentKernelX-x);maxReds=src[offset]*Math.abs(Math.cos(direction[dstOff]-currentKernelAngle))>maxReds?0:maxReds,maxGreens=src[offset+1]*Math.abs(Math.cos(direction[dstOff+1]-currentKernelAngle))>maxGreens?0:maxGreens,maxBlues=src[offset+2]*Math.abs(Math.cos(direction[dstOff+2]-currentKernelAngle))>maxBlues?0:maxBlues}}outputData.data[dstOff]=2*maxReds,outputData.data[dstOff+1]=2*maxGreens,outputData.data[dstOff+2]=2*maxBlues,outputData.data[dstOff+3]=255}return outputData},bigGaussian:function(pixels){var operator=[2/159,4/159,5/159,4/159,2/159,4/159,9/159,12/159,9/159,4/159,5/159,12/159,15/159,12/159,5/159,4/159,9/159,12/159,9/159,4/159,2/159,4/159,5/159,4/159,2/159];return LenaJS.convolution(pixels,operator)},canny:function(pixels){pixels=LenaJS.bigGaussian(pixels);var deltaX=LenaJS.sobelHorizontal(pixels),deltaY=LenaJS.sobelVertical(pixels),r=LenaJS.gradient(deltaX,deltaY),lp=LenaJS.laplacian(pixels);return pixels=LenaJS.nonMaximumSuppression(lp,r.direction),LenaJS.thresholding(pixels,8)},gaussian:function(pixels){var operator=[1/16,2/16,1/16,2/16,.25,2/16,1/16,2/16,1/16];return LenaJS.convolution(pixels,operator)},grayscale:function(pixels){for(var i=0;i<pixels.data.length;i+=4){var r=pixels.data[i],g=pixels.data[i+1],b=pixels.data[i+2];pixels.data[i]=pixels.data[i+1]=pixels.data[i+2]=.2126*r+.7152*g+.0722*b}return pixels},highpass:function(pixels){return LenaJS.convolution(pixels,[-1,-1,-1,-1,8,-1,-1,-1,-1])},invert:function(pixels){for(var i=0;i<pixels.data.length;i+=4)pixels.data[i]=255-pixels.data[i],pixels.data[i+1]=255-pixels.data[i+1],pixels.data[i+2]=255-pixels.data[i+2];return pixels},laplacian:function(pixels){return LenaJS.convolution(pixels,[0,-1,0,-1,4,-1,0,-1,0])},lowpass3:function(pixels){var k=1/9,operator=[k,k,k,k,k,k,k,k,k];return LenaJS.convolution(pixels,operator)},lowpass5:function(pixels){var k=.04,operator=[k,k,k,k,k,k,k,k,k,k,k,k,k,k,k,k,k,k,k,k,k,k,k,k,k];return LenaJS.convolution(pixels,operator)},mirror:function(pixels){for(var tmp=[],width=4*pixels.width,h=0;h<pixels.height;h++)for(var offset=h*width,middle=pixels.width/2,w=0;w<middle;w++){var pos=4*w,pxl=pos+offset,lastPxl=width-pos-4+offset;tmp[0]=pixels.data[pxl],tmp[1]=pixels.data[pxl+1],tmp[2]=pixels.data[pxl+2],tmp[3]=pixels.data[pxl+3],pixels.data[pxl]=pixels.data[lastPxl],pixels.data[pxl+1]=pixels.data[lastPxl+1],pixels.data[pxl+2]=pixels.data[lastPxl+2],pixels.data[pxl+3]=pixels.data[lastPxl+3],pixels.data[lastPxl]=tmp[0],pixels.data[lastPxl+1]=tmp[1],pixels.data[lastPxl+2]=tmp[2],pixels.data[lastPxl+3]=tmp[3]}return pixels},prewittHorizontal:function(pixels){var operator=[1/3,1/3,1/3,0,0,0,-1/3,-1/3,-1/3];return LenaJS.convolution(pixels,operator)},prewittVertical:function(pixels){var operator=[-1/3,0,1/3,-1/3,0,1/3,-1/3,0,1/3];return LenaJS.convolution(pixels,operator)},red:function(pixels){for(var d=pixels.data,i=0;i<d.length;i+=4)d[i]=d[i],d[i+1]=0,d[i+2]=0;return pixels},green:function(pixels){for(var d=pixels.data,i=0;i<d.length;i+=4)d[i]=0,d[i+2]=0;return pixels},blue:function(pixels){for(var d=pixels.data,i=0;i<d.length;i+=4)d[i]=0,d[i+1]=0;return pixels},roberts:function(pixels){return LenaJS.convolution(pixels,[0,0,0,1,-1,0,0,0,0])},saturation:function(pixels){for(var i=0;i<pixels.data.length;i+=4)pixels.data[i]=2.31366*pixels.data[i]+-1.15596*pixels.data[i+1]+-.1558*pixels.data[i+2],pixels.data[i+1]=-.58634*pixels.data[i]+1.7440399999999998*pixels.data[i+1]+-.1558*pixels.data[i+2],pixels.data[i+2]=-.58634*pixels.data[i]+-1.15596*pixels.data[i+1]+2.7441999999999998*pixels.data[i+2];return pixels},sepia:function(pixels){for(var i=0;i<pixels.data.length;i+=4){var r=pixels.data[i],g=pixels.data[i+1],b=pixels.data[i+2];pixels.data[i]=pixels.data[i+1]=pixels.data[i+2]=.3*r+.59*g+.11*b,pixels.data[i]+=40,pixels.data[i+1]+=20,pixels.data[i+2]-=20}return pixels},sharpen:function(pixels){return LenaJS.convolution(pixels,[0,-.2,0,-.2,1.8,-.2,0,-.2,0])},sobelHorizontal:function(pixels){var operator=[1/4,.5,1/4,0,0,0,-1/4,-.5,-1/4];return pixels=LenaJS.convolution(pixels,operator)},sobelVertical:function(pixels){var operator=[1/4,0,-1/4,.5,0,-.5,1/4,0,-1/4];return pixels=LenaJS.convolution(pixels,operator)},thresholding:function(pixels,args){for(var i=0;i<pixels.data.length;i+=4){var v=.2126*pixels.data[i]+.7152*pixels.data[i+1]+.0722*pixels.data[i+2],thr=args||128;pixels.data[i]=pixels.data[i+1]=pixels.data[i+2]=v>thr?255:0}return pixels}};